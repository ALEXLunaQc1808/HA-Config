---
id: '3565344161321'
alias: Utility Meter - Update House Total Energy Usage
initial_state: on
trigger:
  - platform: homeassistant
    event: start
  - platform: time_pattern
    minutes: "*"
#  - platform: mqtt
#    topic: tele/living_room_tv_stand_plug/SENSOR
#  - platform: mqtt
#    topic: tele/laundry_room_washing_machine_plug/SENSOR
#  - platform: mqtt
#    topic: tele/kitchen_dishwasher_plug/SENSOR
#  - platform: mqtt
#    topic: tele/kitchen_toaster_plug/SENSOR
#  - platform: mqtt
#    topic: tele/studio_desk_andrea_plug/SENSOR
#  - platform: mqtt
#    topic: tele/studio_desk_sonia_plug/SENSOR
#  - platform: mqtt
#    topic: tele/studio_table_plug/SENSOR
action:
  - service: mqtt.publish
    data:
      topic: "tele/House/TOTAL_ENERGY"
      payload_template: >-
        {% set ns = namespace(states=[]) %}
        {% for s in states.sensor %}
          {% if not s.object_id.startswith('house_') and s.object_id.endswith('_total_energy_usage') %}
            {% set ns.states = ns.states + [ s.state | float ] %}
          {% endif %}
        {% endfor %}
        {{ ns.states | sum | round(2) }}
#        {{
#        (
#        (states.sensor.living_room_total_energy_usage.state | float) +
#        (states.sensor.kitchen_total_energy_usage.state | float) +
#        (states.sensor.laundry_room_total_energy_usage.state | float) +
#        (states.sensor.studio_total_energy_usage.state | float)
#        )
#        | round(3)
#        }}
      qos: 1
      retain: false

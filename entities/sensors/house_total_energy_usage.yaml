---
platform: template
sensors:
  house_total_energy_usage:
    friendly_name: House Daily Energy Usage
    entity_id: sensor.time
    unit_of_measurement: kWh
    icon_template: mdi:counter
    availability_template: >
      {% set ns = namespace(states=[]) %}
      {% for s in states.sensor %}
        {% if not s.object_id.startswith('house_') and s.object_id.endswith('_total_energy_usage') %}
          {% if ( s.state ) not in ['unknown', 'unavailable'] and ( ns.state ) not in ['False'] %}
            {% set ns.states = "True" %}
          {% else %}
            {% set ns.states = "False" %}
          {% endif %}
        {% endif %}
      {% endfor %}
      {{ ns.states }}
    value_template: >
      {% set ns = namespace(states=[]) %}
      {% for s in states.sensor %}
        {% if not s.object_id.startswith('house_') and s.object_id.endswith('_total_energy_usage') %}
          {% set ns.states = ns.states + [ states(s.entity_id) | float ] %}
        {% endif %}
      {% endfor %}
      {{ ns.states | sum | round(3) }}
      {% if [ states('ns.states') | float ] < [ states('sensor.house_total_energy_usage') | float ] %}
        {% set ns.states = sensor.house_total_energy_usage %}
      {% endif %}
